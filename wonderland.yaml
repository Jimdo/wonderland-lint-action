---
scale: 2
components:
  - name: crons
    image: {{env `CRONS_IMAGE`}}
    env:
      AWS_REGION: '{{env `NOMAD_AWS_REGION`}}'
      CRON_ROLE_ARN: '{{ env `CRON_ROLE_ARN`}}'
      ECS_CLUSTER_ARN: '{{ env `ECS_CLUSTER_ARN`}}'
      ECS_EVENTS_QUEUE_URL: {{env `ECS_EVENTS_QUEUE_URL`}}
      NOMAD_API: '{{env `NOMAD_API`}}'
      NOMAD_WL_DOCKER_IMAGE: '{{ env `NOMAD_WL_DOCKER_IMAGE`}}'
      WONDERLAND_ENV: '{{env `WONDERLAND_ENV`}}'
      WONDERLAND_REGISTRY_ADDRESS: '{{env `WONDERLAND_REGISTRY` }}'
      CRONS_TABLE_NAME: '{{env `CRONS_TABLE_NAME` }}'
      TASKS_TABLE_NAME: '{{env `TASKS_TABLE_NAME` }}'
      $ref_secrets: vault+secret://vault.{{env `ZONE`}}/wonderland/crons
    capacity:
      memory: M
      CPU: L
    logging:
      types:
        - json
  - name: auth-proxy
    image: {{env `AUTH_PROXY_IMAGE`}}
    links:
      - component: crons
        alias: app
    env:
      APP_PORT: '8000'
      APP_HEALTHCHECK: /v1/status
      $ref_secrets: vault+secret://vault.{{env `ZONE`}}/wonderland/crons/proxy
    logging:
      types:
        - access_log
        - error_log_nginx
endpoint:
  component: auth-proxy
  domain: crons.{{env `ZONE`}}
  healthcheck: /v1/status
  port: 80
notifications:
{{if eq (env `WONDERLAND_ENV`) "prod"}}
  pagerduty: https://events.pagerduty.com/adapter/cloudwatch_sns/v1/33046cc63c3d4e6dafda9c336be58ae8
{{end}}
  slack: '#werkzeugschmiede-bot'
