---
scale: 2
components:
  - name: crons
    image: {{env `CRONS_IMAGE`}}
    env:
      AWS_REGION: '{{env `AWS_REGION`}}'
      CRON_ROLE_ARN: '{{ env `CRON_ROLE_ARN`}}'
      ECS_CLUSTER_ARN: '{{ env `ECS_CLUSTER_ARN`}}'
      ECS_EVENTS_QUEUE_URL: {{env `ECS_EVENTS_QUEUE_URL`}}
      WONDERLAND_ENV: '{{env `WONDERLAND_ENV`}}'
      WONDERLAND_REGISTRY_ADDRESS: '{{env `WONDERLAND_REGISTRY` }}'
      CRONS_TABLE_NAME: '{{env `CRONS_TABLE_NAME` }}'
      EXECUTIONS_TABLE_NAME: '{{env `EXECUTIONS_TABLE_NAME` }}'
      WORKER_LEADER_LOCK_TABLE_NAME: '{{env `WORKER_LEADER_LOCK_TABLE_NAME`}}'
      EXEC_TRIGGER_TOPIC_ARN: '{{env `EXEC_TRIGGER_TOPIC_ARN`}}'
      NO_SCHEDULE_ATTRIBUTE: '{{env `NO_SCHEDULE_ATTRIBUTE`}}'
      TIMEOUT_IMAGE: '{{ env `TIMEOUT_IMAGE` }}'
      NOTIFICATIONS_API: '{{env `NOTIFICATIONS_API`}}'
      $ref_secrets: vault+secret://vault.{{env `ZONE`}}/wonderland/crons
    capacity:
      memory: M
      CPU: L
    logging:
      types:
        - json
  - name: auth-proxy
    image: {{env `AUTH_PROXY_IMAGE`}}
    links:
      - component: crons
        alias: app
    env:
      APP_PORT: '8000'
      APP_HEALTHCHECK: /status
      $ref_secrets: vault+secret://vault.{{env `ZONE`}}/wonderland/crons/proxy
    logging:
      types:
        - access_log
        - error_log_nginx
endpoint:
  component: auth-proxy
  domain: crons.{{env `ZONE`}}
  healthcheck: /status
  port: 80
metrics:
  prometheus:
    - component: crons
      container-port: 8000
notifications:
{{if eq (env `WONDERLAND_ENV`) "prod"}}
  pagerduty: https://events.pagerduty.com/adapter/cloudwatch_sns/v1/33046cc63c3d4e6dafda9c336be58ae8
{{end}}
  slack: "#ws-alerts-{{ env `WONDERLAND_ENV`}}"
